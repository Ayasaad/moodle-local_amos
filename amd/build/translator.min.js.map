{"version":3,"sources":["../src/translator.js"],"names":["init","registerEventListeners","turnAllMissingForEditing","PubSub","subscribe","FilterEvents","submit","filterquery","showFilteredStrings","root","document","getElementById","addEventListener","e","target","classList","contains","item","closest","getAttribute","translatorItemEditingOn","ctrlKey","focus","hasAttribute","preventDefault","showTimeline","markUpToDate","paginatorlink","publish","TranslatorEvents","pagechange","translatorItemSave","nocleaning","textarea","querySelector","refHeight","clientHeight","setAttribute","value","style","height","previoustext","newtext","trim","Promise","resolve","add","remove","disabled","stageTranslatedString","then","response","removeAttribute","innerHTML","translation","displaytranslation","displaytranslationsince","catch","Notification","exception","text","methodname","args","stageid","Config","sesskey","originalid","lang","translationid","parseInt","missingItems","querySelectorAll","forEach","filterQuery","loadingIndicator","data","JSON","parse","json","Templates","render","error","reject","html","js","replaceNodeContents","component","language","strname","ModalFactory","create","large","title","body","modal","getRoot","on","ModalEvents","hidden","destroy","show"],"mappings":"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","sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * JS module for the AMOS translator.\n *\n * @module      local_amos/translator\n * @package     local_amos\n * @copyright   2020 David Mudr√°k <david@moodle.com>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {call as fetchMany} from 'core/ajax';\nimport Config from 'core/config';\nimport Notification from 'core/notification';\nimport * as PubSub from 'core/pubsub';\nimport FilterEvents from './filter_events';\nimport TranslatorEvents from './translator_events';\nimport Templates from 'core/templates';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport {get_string as getString} from 'core/str';\n\n/**\n * @function init\n */\nexport const init = () => {\n    registerEventListeners();\n    turnAllMissingForEditing();\n\n    PubSub.subscribe(FilterEvents.submit, filterquery => {\n        showFilteredStrings(filterquery);\n    });\n};\n\n/**\n * @function registerEventListeners\n */\nconst registerEventListeners = () => {\n    let root = document.getElementById('amostranslator');\n\n    root.addEventListener('click', e => {\n        // Check to see if the user clicked on a translation to edit it.\n        if (e.target.classList.contains('amostranslation') || e.target.classList.contains('amostranslationview')) {\n            let item = e.target.closest('[data-region=\"amostranslatoritem\"].translatable');\n\n            if (item.getAttribute('data-mode') == 'view') {\n                translatorItemEditingOn(item, e.ctrlKey).focus();\n                return;\n            }\n        }\n\n        // String history timeline link.\n        if (e.target.hasAttribute('data-region') && e.target.getAttribute('data-region') == 'timelinelink') {\n            let item = e.target.closest('[data-region=\"amostranslatoritem\"]');\n            e.preventDefault();\n            showTimeline(item);\n            return;\n        }\n\n        // Marking translation as up-to-date.\n        if (e.target.hasAttribute('data-region') && e.target.getAttribute('data-region') == 'markuptodatelink') {\n            let item = e.target.closest('[data-region=\"amostranslatoritem\"]');\n            e.preventDefault();\n            markUpToDate(item);\n            return;\n        }\n\n\n        // Check to see if the user clicked on paginator link.\n        let paginatorlink = e.target.closest('[data-paginatorlink]');\n        if (paginatorlink) {\n            e.preventDefault();\n            PubSub.publish(TranslatorEvents.pagechange, paginatorlink.getAttribute('data-paginatorlink'));\n        }\n    });\n\n    root.addEventListener('blur', e => {\n        if (e.target.hasAttribute('data-region') && e.target.getAttribute('data-region') == 'amoseditor') {\n            translatorItemSave(e.target);\n        }\n    }, true);\n};\n\n/**\n * @function translatorItemEditingOn\n * @param {Element} item\n * @param {bool} [nocleaning=false] - turn editing on with nocleaning enabled\n * @return {Element}\n */\nconst translatorItemEditingOn = (item, nocleaning = false) => {\n    let textarea = item.querySelector('[data-region=\"amoseditor\"]');\n    let refHeight = item.querySelector('.amostranslation').clientHeight;\n\n    item.setAttribute('data-nocleaning', nocleaning ? '1' : '0');\n    textarea.setAttribute('data-previous', textarea.value);\n\n    if (refHeight > 40) {\n        textarea.style.height = (refHeight - 9) + 'px';\n    }\n\n    item.setAttribute('data-mode', 'edit');\n\n    return textarea;\n};\n\n/**\n * @function translatorItemSave\n * @param {Element} textarea\n * @return {Promise}\n */\nconst translatorItemSave = (textarea) => {\n    let item = textarea.closest('[data-region=\"amostranslatoritem\"]');\n    let nocleaning = item.getAttribute('data-nocleaning');\n    let previoustext = textarea.getAttribute('data-previous');\n    let newtext = textarea.value;\n\n    if (nocleaning === '1') {\n        newtext = newtext.trim();\n    }\n\n    if (previoustext === newtext && nocleaning !== '1') {\n        // Remove eventually added trailing/heading whitespace and just switch back.\n        textarea.value = previoustext;\n        item.setAttribute('data-mode', 'view');\n\n        return Promise.resolve(false);\n\n    } else {\n        // Send the translation to the stage if the translation has changed or nocleaning applies.\n        item.classList.add('staged');\n        item.classList.remove('outdated');\n        textarea.disabled = true;\n\n        return stageTranslatedString(item, newtext)\n\n        .then(response => {\n            item.setAttribute('data-mode', 'view');\n            textarea.disabled = false;\n            textarea.removeAttribute('data-previous');\n            textarea.innerHTML = textarea.value = response.translation;\n            item.querySelector('[data-region=\"amostranslationview\"]').innerHTML = response.displaytranslation;\n            item.querySelector('[data-region=\"displaytranslationsince\"]').innerHTML = response.displaytranslationsince + ' | ';\n            item.querySelector('[data-region=\"markuptodatelink\"]')?.remove();\n\n            return true;\n\n        }).catch(Notification.exception);\n    }\n};\n\n/**\n * @function stageTranslatedString\n * @param {Element} item\n * @param {string} text\n * @returns {Promise}\n */\nconst stageTranslatedString = (item, text) => {\n\n    return fetchMany([{\n        methodname: 'local_amos_stage_translated_string',\n        args: {\n            stageid: Config.sesskey,\n            originalid: item.getAttribute('data-originalid'),\n            lang: item.getAttribute('data-language'),\n            text: text,\n            translationid: parseInt(item.getAttribute('data-translationid')) || 0,\n            nocleaning: item.getAttribute('data-nocleaning'),\n        },\n    }])[0];\n};\n\n/**\n * @function turnAllMissingForEditing\n */\nconst turnAllMissingForEditing = () => {\n    let root = document.getElementById('amostranslator');\n    let missingItems = root.querySelectorAll(':scope [data-region=\"amostranslatoritem\"].translatable.missing');\n    missingItems.forEach(translatorItemEditingOn);\n};\n\n/**\n * @function showFilteredStrings\n */\nconst showFilteredStrings = (filterQuery) => {\n\n    let root = document.getElementById('amostranslator');\n    let loadingIndicator = document.getElementById('amosfilter_loading_indicator');\n\n    root.classList.add('loading');\n\n    return fetchMany([{\n        methodname: 'local_amos_get_translator_data',\n        args: {\n            filterquery: filterQuery,\n        },\n\n    }])[0].then(response => {\n        try {\n            let data = JSON.parse(response.json);\n            return Templates.render('local_amos/translator_root', data);\n\n        } catch (error) {\n            return Promise.reject(error);\n        }\n\n    }).then((html, js = '') => {\n        return Templates.replaceNodeContents(root, html, js);\n\n    }).then(() => {\n        turnAllMissingForEditing();\n        loadingIndicator.classList.add('hidden');\n        root.classList.remove('loading');\n        return true;\n\n    }).catch(Notification.exception);\n};\n\n/**\n * @function showTimeline\n * @param {Element} item\n */\nconst showTimeline = (item) => {\n    return fetchMany([{\n        methodname: 'local_amos_get_string_timeline',\n        args: {\n            component: item.getAttribute('data-component'),\n            language: item.getAttribute('data-language'),\n            strname: item.getAttribute('data-stringid'),\n        },\n\n    }])[0].then(response => {\n        return Templates.render('local_amos/timeline', response);\n\n    }).then((html) => {\n        return ModalFactory.create({\n            large: true,\n            title: getString('timeline', 'local_amos'),\n            body: html,\n        });\n\n    }).then(modal => {\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            modal.destroy();\n        });\n\n        modal.show();\n\n        return modal;\n\n    }).catch(Notification.exception);\n};\n\n/**\n * @function markUpToDate\n * @param {Element} item\n */\nconst markUpToDate = (item) => {\n    return fetchMany([{\n        methodname: 'local_amos_make_translation_uptodate',\n        args: {\n            originalid: item.getAttribute('data-originalid'),\n            translationid: item.getAttribute('data-translationid'),\n        },\n\n    }])[0].then(response => {\n        item.classList.remove('outdated');\n        item.setAttribute('data-translationid', response.translationid);\n        item.querySelector('[data-region=\"displaytranslationsince\"]').innerHTML = response.displaytranslationsince + ' | ';\n        item.querySelector('[data-region=\"markuptodatelink\"]').remove();\n\n    }).catch(Notification.exception);\n};\n"],"file":"translator.min.js"}