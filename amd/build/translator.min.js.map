{"version":3,"sources":["../src/translator.js"],"names":["init","registerEventListeners","turnAllMissingForEditing","PubSub","subscribe","FilterEvents","submit","filterquery","showFilteredStrings","root","document","getElementById","addEventListener","e","target","classList","contains","item","closest","getAttribute","translatorItemEditingOn","ctrlKey","focus","hasAttribute","translatorItemSave","nocleaning","textarea","querySelector","refHeight","clientHeight","setAttribute","value","style","height","previoustext","newtext","trim","Promise","resolve","add","disabled","stageTranslatedString","then","response","removeAttribute","innerHTML","translation","displaytranslation","displaytranslationsince","catch","Notification","exception","text","methodname","args","stageid","Config","sesskey","originalid","lang","translationid","parseInt","missingItems","querySelectorAll","forEach","filterQuery","data","JSON","parse","json","Templates","render","error","reject","html","js","replaceNodeContents","remove"],"mappings":"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","sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * JS module for the AMOS translator.\n *\n * @module      local_amos/translator\n * @package     local_amos\n * @copyright   2020 David Mudr√°k <david@moodle.com>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {call as fetchMany} from 'core/ajax';\nimport Config from 'core/config';\nimport Notification from 'core/notification';\nimport * as PubSub from 'core/pubsub';\nimport FilterEvents from './filter_events';\nimport Templates from 'core/templates';\n\n/**\n * @function init\n */\nexport const init = () => {\n    registerEventListeners();\n    turnAllMissingForEditing();\n\n    PubSub.subscribe(FilterEvents.submit, filterquery => {\n        showFilteredStrings(filterquery);\n    });\n};\n\n/**\n * @function registerEventListeners\n */\nconst registerEventListeners = () => {\n    let root = document.getElementById('amostranslator');\n\n    root.addEventListener('click', e => {\n        if (e.target.classList.contains('amostranslation') || e.target.classList.contains('amostranslationview')) {\n            let item = e.target.closest('[data-region=\"amostranslatoritem\"]');\n\n            if (item.getAttribute('data-mode') == 'view') {\n                translatorItemEditingOn(item, e.ctrlKey).focus();\n            }\n        }\n    });\n\n    root.addEventListener('blur', e => {\n        if (e.target.hasAttribute('data-region') && e.target.getAttribute('data-region') == 'amoseditor') {\n            translatorItemSave(e.target);\n        }\n    }, true);\n};\n\n/**\n * @function translatorItemEditingOn\n * @param {Element} item\n * @param {bool} [nocleaning=false] - turn editing on with nocleaning enabled\n * @return {Element}\n */\nconst translatorItemEditingOn = (item, nocleaning = false) => {\n    let textarea = item.querySelector('[data-region=\"amoseditor\"]');\n    let refHeight = item.querySelector('.amostranslation').clientHeight;\n\n    item.setAttribute('data-nocleaning', nocleaning ? '1' : '0');\n    textarea.setAttribute('data-previous', textarea.value);\n\n    if (refHeight > 40) {\n        textarea.style.height = (refHeight - 9) + 'px';\n    }\n\n    item.setAttribute('data-mode', 'edit');\n\n    return textarea;\n};\n\n/**\n * @function translatorItemSave\n * @param {Element} textarea\n * @return {Promise}\n */\nconst translatorItemSave = (textarea) => {\n    let item = textarea.closest('[data-region=\"amostranslatoritem\"]');\n    let nocleaning = item.getAttribute('data-nocleaning');\n    let previoustext = textarea.getAttribute('data-previous');\n    let newtext = textarea.value;\n\n    if (nocleaning === '1') {\n        newtext = newtext.trim();\n    }\n\n    if (previoustext === newtext && nocleaning !== '1') {\n        // Remove eventually added trailing/heading whitespace and just switch back.\n        textarea.value = previoustext;\n        item.setAttribute('data-mode', 'view');\n\n        return Promise.resolve(false);\n\n    } else {\n        // Send the translation to the stage if the translation has changed or nocleaning applies.\n        item.classList.add('staged');\n        textarea.disabled = true;\n\n        return stageTranslatedString(item, newtext)\n\n        .then(response => {\n            item.setAttribute('data-mode', 'view');\n            textarea.disabled = false;\n            textarea.removeAttribute('data-previous');\n            textarea.innerHTML = textarea.value = response.translation;\n            item.querySelector('[data-region=\"amostranslationview\"]').innerHTML = response.displaytranslation;\n            item.querySelector('[data-region=\"displaytranslationsince\"]').innerHTML = response.displaytranslationsince + ' | ';\n\n            return true;\n\n        }).catch(Notification.exception);\n    }\n};\n\n/**\n * @function stageTranslatedString\n * @param {Element} item\n * @param {string} text\n * @returns {Promise}\n */\nconst stageTranslatedString = (item, text) => {\n\n    return fetchMany([{\n        methodname: 'local_amos_stage_translated_string',\n        args: {\n            stageid: Config.sesskey,\n            originalid: item.getAttribute('data-originalid'),\n            lang: item.getAttribute('data-language'),\n            text: text,\n            translationid: parseInt(item.getAttribute('data-translationid')) || 0,\n            nocleaning: item.getAttribute('data-nocleaning'),\n        },\n    }])[0];\n};\n\n/**\n * @function turnAllMissingForEditing\n */\nconst turnAllMissingForEditing = () => {\n    let root = document.getElementById('amostranslator');\n    let missingItems = root.querySelectorAll(':scope [data-region=\"amostranslatoritem\"].missing');\n    missingItems.forEach(translatorItemEditingOn);\n};\n\n/**\n * @function showFilteredStrings\n */\nconst showFilteredStrings = (filterQuery) => {\n\n    let root = document.getElementById('amostranslator');\n    root.classList.add('loading');\n\n    return fetchMany([{\n        methodname: 'local_amos_get_translator_data',\n        args: {\n            filterquery: filterQuery,\n        },\n\n    }])[0].then(response => {\n        try {\n            let data = JSON.parse(response.json);\n            return Templates.render('local_amos/translator_root', data);\n\n        } catch (error) {\n            return Promise.reject(error);\n        }\n\n    }).then((html, js = '') => {\n        return Templates.replaceNodeContents(root, html, js);\n\n    }).then(() => {\n        turnAllMissingForEditing();\n        root.classList.remove('loading');\n        return true;\n\n    }).catch(Notification.exception);\n};\n"],"file":"translator.min.js"}